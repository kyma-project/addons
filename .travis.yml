language: go

go:
- "1.10"

# Skip the install step. Don't `go get` dependencies.
install: skip

# Only clone the most recent commit.
git:
  depth: 1

notifications:
  email: false

script: skip

branch:
  except:
    - latest

jobs:
  include:
  - stage: check
    script: ./scripts/checker.sh --helm-lint --directories ./bundles --helm-version v2.10.0

  # creates a release from the tagged version
  - stage: deploy
  # do we need such condition?
#    if: (NOT type IN (pull_request))
    before_deploy:
     - ./scripts/convert.sh
    env:
    deploy:
      provider: releases
      skip_cleanup: true
      api_key: $GITHUB_TOKEN
      file_glob: true
      file: "toCopy/*"
      name: $TRAVIS_TAG
      on:
        # Only tagged commit triggers a release deploy
        tags: true

  # creates a latest release from last master commit
  - stage: deploy
    if: (NOT type IN (pull_request)) AND (branch = master)
    before_deploy:
     - git config --global user.email "builds@travis-ci.com"
     - git config --global user.name "Travis CI"
     - export GIT_TAG=latest
     - git tag $GIT_TAG -a -m "Generated tag from TravisCI"
     - git push https://${GITHUB_TOKEN}@github.com/${TRAVIS_REPO_SLUG} $GIT_TAG -f
     - ./scripts/convert.sh
    env:
    deploy:
      provider: releases
      overwrite: true
      skip_cleanup: true
      api_key: $GITHUB_TOKEN
      file_glob: true
      file: "toCopy/*"